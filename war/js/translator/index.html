<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Repl 2.0</title>

<style>
  td {min-width: 10px; max-width: 300px; overflow: hidden;}
</style>
<script type="text/javascript" src="../mzscheme-vm/support.js"></script>
<script type="text/javascript" src="structures.js"></script>
<script type="text/javascript" src="modules.js"></script>
<script type="text/javascript" src="compiler.js"></script>
<script type="text/javascript" src="analyzer.js"></script>
<script type="text/javascript" src="parser.js"></script>
<script type="text/javascript" src="lex.js"></script>
<script type="text/javascript" src="repl2.js"></script>
  
<script>
var rows    = [];
var tests   = [];
var passed  = 0;
var testsRun= 0;
// dictionaries of toplevel names for x and y bytecodes
var x_toplevels = [], y_toplevels = [],
    extractTopLevelName = function (tl){
      if(!tl) return false;
      if(tl.$ === 'global-bucket') return tl.value;
      if(tl.$ === 'module-variable') return tl.sym.val;
      else throw "UNKNOWN TOPLEVEL TYPE: "+tl.toString();
}

// sameResults : local server -> boolean
// Weak comparison on locations, indirect comparison for toplevel references
// Recursive comparison for objects
// Strong comparison for literals
// if there's a difference, log a diff to the form and return false
// credit to: http://stackoverflow.com/questions/1068834/object-comparison-in-javascript
function sameResults(x, y){
  
  // given an object, remove empty properties and reconstruct as an alphabetized JSON string
  // then parse and return a canonicalized object
  function canonicalizeObject(obj){
    var fields = [], obj2={};
    for (i in obj) { if (obj.hasOwnProperty(i) && obj[i] !== "") fields.push(i); }
    fields.sort();
    for (var i=0;i<fields.length; i++) { obj2[fields[i]] = obj[fields[i]]; }
    return obj2;
  }
  
  function canonicalizeLiteral(lit){
    return lit.toString().replace(/\s*/g,"").toLowerCase();
  }

  // if either one is a JSON string, convert it to an object
  try{ var x = JSON.parse(x); }
  catch(e) { /* if it doesn't parse correctly, proceed silently */ }
  try{ var y = JSON.parse(y);}
  catch(e) { /* if it doesn't parse correctly, proceed silently */ }

  // if either one is an object, canonicalize it
  if(typeof(x) === "object") x = canonicalizeObject(x);
  if(typeof(y) === "object") y = canonicalizeObject(y);

  // 1) if both are Locations, we only care about offset and span, so perform a weak comparison
  if ( x.hasOwnProperty('offset') && y.hasOwnProperty('offset') ){
    return ( (x.span == y.span) && (x.offset == y.offset) );
  }
  // 2) if both objects have a prefix field, build our dictionaries *before* moving on
  if(x.hasOwnProperty('prefix') && y.hasOwnProperty('prefix')){
    x_toplevels = x.prefix.toplevels.map(extractTopLevelName);
    y_toplevels = y.prefix.toplevels.map(extractTopLevelName);
  }
  // 3) if they are both objects, compare each property
  if(typeof(x)=="object" && typeof(x)=="object"){
    // does every property in x also exist in y?
    for (var p in x) {
      // log error if a property is not defined
      if ( ! x.hasOwnProperty(p) ){ console.log('expected lacks a '+p); return false; }
      if ( ! y.hasOwnProperty(p) ){ console.log('recieved lacks a '+p); return false; }
      // ignore the hashcode property
      if(p==="_eqHashCode") continue;
      // toplevel properties are equal if the sets of names are equal
      // WARNING: this may require stronger checking!
      if(p==="toplevels"){
        // if they're not the same length, bail
        if(x_toplevels.length !== y_toplevels.length){
          console.log('different number of toplevels'); return false;
        }
        // if they're not the same names, bail
        if(!x_toplevels.every(function(v,i) { return y_toplevels.indexOf(v) > -1;})){
          console.log('different toplevel names'); return false;
        }
        // build sorted lists of all module variables, return true if they are identical
        x_modVariables = x.toplevels.filter(function(tl){return tl.$==="module-variable"});
        y_modVariables = y.toplevels.filter(function(tl){return tl.$==="module-variable"});
        x_modVariables.sort(function(a,b){return (a.sym.val > b.sym.val)});
        y_modVariables.sort(function(a,b){return (a.sym.val > b.sym.val)});
        return sameResults(x_modVariables, y_modVariables);
      }
      // use pos's as keys into the toplevel dictionaries, and compare their values
      if((p==="pos") && (x["$"]==="toplevel") && (x["$"]==="toplevel")){
        if(x_toplevels[Number(x[p])] === y_toplevels[Number(y[p])]){ return true; }
        else { console.log('different indices for '+x_toplevels[Number(x[p])]); return false; }
      }
      // if they both have the property, compare it
      if(sameResults(x[p],y[p])) continue;
      else{ return false;}
    }
    // does every property in y also exist in x?
    for (p in y) {
      // log error if a property is not defined
      if ( y.hasOwnProperty(p) && !x.hasOwnProperty(p) ){ return false; }
    }
  // 4)if they are literals, they must be identical
  } else {
      if (canonicalizeLiteral(x) !== canonicalizeLiteral(y)){
        console.log('(expexted, local) literals not the same:\n'+x+'\nis not equal to \n'+y);
        return false;
      }
  }
  return true;
}

// set the parent row to pink, and add a link that will load
// a diff of the expected and recieved output
function setTestFailureLink(test, expected, recieved){
  test.style.background = 'pink';
  test.style.cursor     = 'pointer';
  test.onclick = function(){compareText(expected,recieved);}
  return false;
}

function compareText(expected, recieved){
  document.getElementById('text1').value = expected;
  document.getElementById('text2').value = recieved;
  document.getElementById('compareText').submit();
}

function loadTests(){
  var testButton = document.getElementById('runTests'),
      script  = document.createElement('script'),
      head    = document.getElementsByTagName('head')[0];
  testButton.disabled = true;
  testButton.value = "Loading tests...";
  head.appendChild(script);
  script.type = "text/javascript";
  script.src = "https://spreadsheets.google.com/feeds/list/0AjzMl1BJlJDkdDI2c0VUSHNZMnR6ZVR5S2hXZEdtd1E/1/public/basic?alt=json-in-script&callback=loadSuite";
}

function loadSuite(json){
  var which   = document.getElementById('whichTests');
  for(var i=0; i<json.feed.entry.length; i++){
    rows.push(json.feed.entry[i].content.$t);
    var chunks = rows[i].split(/expr\:|, local\: |, server\: |, firstdifference\: |, reason\: |, desugar\: |, bytecode\: /);
    var expr = chunks[1].replace(/^\s+/,""), local = chunks[2], server = chunks[3],
               difference = chunks[4], reason = chunks[5], desugar = chunks[6], bytecode = chunks[7],
        opt = document.createElement('option');
    expr = expr.replace(/^\'\'/,"'");
    tests.push({expr: expr, local: local, server: server, reason: reason, desugar: desugar, bytecode: bytecode});
    opt.value=opt.innerHTML = Number(i)+1;
    which.appendChild(opt);
  }
  console.log(document.getElementById('runTests'));
  document.getElementById('runTests').disabled=false;
  document.getElementById('runTests').value="Run test:";
  document.getElementById('runTests').onclick=function(){runTests(true);};
  document.getElementById('memoryTest').disabled=false;
  console.log('Test Suite data retrieved from Google Drive: '+tests.length+' tests loaded');
  which.style.display = 'inline-block';
}

function runTests(verbose){
  function test(expr, expected, desugarRef, bytecodeRef){
      // show the result
      var row   = document.createElement('tr'),
          num   = document.createElement('td'),
          test  = document.createElement('td'),
          lex   = document.createElement('td'),
          parse = document.createElement('td'),
          desugar=document.createElement('td'),
          bytecode=document.createElement('td');
      num.innerHTML  = (i+1)+')'; // make test nums 1-aligned, instead of 0-aligned
      test.innerHTML = expr;      // show which expr we're testing
      row.appendChild(num);
      row.appendChild(test);
      row.appendChild(lex);
      row.appendChild(parse);
      row.appendChild(desugar);
      row.appendChild(bytecode);
      table.appendChild(row);
      row.style.background = 'lightgreen';
                        
      // LEX: If we pass when we shouldn't, set to pink and return false.
      // Catch: If we fail better than the server, set to blue and return true.
      // Catch: If we fail equal to the server, set to green and return true.
      // Catch: If we fail when we shoulnd't, set to pink and return false
      lex.innerHTML = 'lex';
      try{
        var sexp = plt.compiler.lex(expr,"<definitions>");
      } catch (recieved) {
        if(expected === "LOCAL IS BETTER"){ lex.style.background = 'lightblue'; return true; }
        if(expected === "PASS"){ return setTestFailureLink(row, expected, recieved);}
        else{
          if(sameResults(JSON.parse(recieved), JSON.parse(expected))){ lex.style.background = 'lightgreen'; return true; }
          else{ return setTestFailureLink(row, expected, recieved);}
        }
      }
      lex.style.background = 'lightgreen';

      // PARSE: If we pass when we shouldn't, set to pink and return false.
      // Catch: If we fail better than the server, set to blue and return true.
      // Catch: If we fail equal to the server, set to green and return true.
      // Catch: If we fail when we shoulnd't, set to pink and return false
      parse.innerHTML = 'parse';
      try{
        var AST = plt.compiler.parse(sexp);
      } catch (recieved) {
        if(expected === "LOCAL IS BETTER"){ parse.style.background = 'lightblue'; return true; }
        if(expected === "PASS"){ return setTestFailureLink(row, expected, recieved);}
        else{
          if(sameResults(JSON.parse(recieved), JSON.parse(expected))){ parse.style.background = 'lightgreen'; return true; }
          else{ return setTestFailureLink(row, expected, recieved);}
        }
      }
      parse.style.background = 'lightgreen';

      // DESUGAR AND ANALYZE: If we pass when we shouldn't, set to pink and return false.
      // Catch: If we fail better than the server, set to blue and return true.
      // Catch: If we fail equal to the server, set to green and return true.
      // Catch: If we fail when we shoulnd't, set to pink and return false
      desugar.innerHTML = 'desugar';
      try{
        var desugared = plt.compiler.desugar(AST),
            recieved  = program=desugared[0],
            pinfo     = desugared[1],
            pinfo2    = plt.compiler.analyze(program);
      } catch (recieved) {
        if(expected === "LOCAL IS BETTER"){ desugar.style.background = 'lightblue'; return true; }
        if(expected === "PASS"){ return setTestFailureLink(row, expected, recieved);}
        else if(sameResults(JSON.parse(recieved), JSON.parse(expected))){ desugar.style.background = 'lightgreen'; return true; }
        else{ return setTestFailureLink(row, expected, recieved);}
      }
      // if we don't have a desugarRef for this test, call it a questinonable pass move on
      if(desugarRef === undefined) { desugar.style.background = 'rgb(194, 288, 194)'; return true; }
      expected = desugarRef.replace(/\s*/g,"");     // remove whitespace fom desugar reference
      recieved = recieved.toString().replace(/\s*/g,"");// remove whitespace from test output
      if(expected !== recieved) { return setTestFailureLink(row, expected, recieved);}
      desugar.style.background = 'lightgreen';

      bytecode.innerHTML = 'bytecode';
      try {
        console.log("// COMPILATION: //////////////////////////////\n");
        var recieved    = JSON.stringify(plt.compiler.compile(program, pinfo2));
      } catch (recieved) {
        if(recieved instanceof unimplementedException){throw recieved.str + " NOT IMPLEMENTED";}
        throw Error("COMPILATION ERROR\n"+getError(recieved).toString());
      }
      // if we don't have a bytecodeRef for this test, call it a questinonable pass move on
      if(bytecodeRef === undefined) { desugar.style.background = 'rgb(194, 288, 194)'; return true; }
      expected = JSON.parse(bytecodeRef);
      recieved = JSON.parse(recieved);
      console.log((0,eval)('('+expected.bytecode+')'));
      try { console.log((0,eval)('('+recieved.bytecode+')'));}
      catch(e){console.log('MALFORMED BYTECODE:\n'+recieved.bytecode); return setTestFailureLink(row, expected.bytecode, recieved.bytecode); }
      if(sameResults((0,eval)('('+expected.bytecode+')'), (0,eval)('('+recieved.bytecode+')'))) {
        desugar.style.background = 'lightgreen'; return true;
      } else {
//                        console.log('compared\n'+expected.bytecode+'\nto\n'+recieved.bytecode);
        return setTestFailureLink(row, JSON.stringify(expected.bytecode), JSON.stringify(recieved.bytecode));
      }

      // EVERYTHING PASSED! WHOOPIE!
      bytecode.style.background = 'lightgreen';
                        
      return true;
 
    }
 
    if(verbose) console.log('running tests');
    var table = document.getElementById('testResults'),
        start = 0, end = tests.length;
    var whichValue = document.getElementById('whichTests').value;
    if(whichValue !== "all"){start=Number(whichValue)-1; end=start+1;}
    for(var i=start; i<end; i++){
      // run the test
      if(verbose) console.log('///// TEST '+ (i+1) +' ////////////////');
      if(verbose) console.log('testing :'+tests[i].expr);
      var result = test(tests[i].expr, tests[i].server, tests[i].desugar, tests[i].bytecode);
      if(result) passed++;
      testsRun++;
      document.getElementById('status').innerHTML = passed+'/'+(testsRun)+' passed. <b>Click on failures to see a Diff of the output</b>.';
    }
}
                        
function runMemoryTest(){
  var runs = prompt("How many runs of the test suite would you like to do?"
                    +"This could take a while depending on how many runs are entered,"
                    +"and your computer may become unresponsive."
                    , 20);
  for(i=0; i<runs; i++) runTests(false);
  console.log('Memory test complete');
}
</script>

</head>
<body onload="repl2_setup()">
<textarea cols="80" rows="5" type="text" name="repl-input" id="repl-input" onkeypress="readFromRepl(event)"></textarea>
<hr>
<input type="button" value="Load test-suite" id="runTests" onclick="loadTests();" style="width: 100px;"/>
<select id="whichTests" style="display: none;">
  <option value="all">all</option>
</select>
<br/>
<input type="button" disabled="true" value="Memory Stress-Test" id="memoryTest" onclick="runMemoryTest()"/>
<br/>
<span id="status"></span>
<table id="testResults" style="font-family:monospace;">
</table>

<form id="compareText" target="_blank" method="post" action="http://text-compare.com/" style="display: none;">
	<textarea name="text1" id="text1"></textarea>
	<textarea name="text2" id="text2"></textarea>
	<button type="submit" id="compareButton">Compare!</button>
</form>


</body>
</html>