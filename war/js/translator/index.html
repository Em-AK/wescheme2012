<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Repl 2.0</title>

<style>
  td {min-width: 10px; max-width: 300px; overflow: hidden;}
</style>
<script type="text/javascript" src="../mzscheme-vm/support.js"></script>
<script type="text/javascript" src="structures.js"></script>
<script type="text/javascript" src="compiler.js"></script>
<script type="text/javascript" src="analyzer.js"></script>
<script type="text/javascript" src="parser.js"></script>
<script type="text/javascript" src="lex.js"></script>
<script type="text/javascript" src="repl2.js"></script>
  
<script>
var rows = [];
var tests = [];
var passed = 0;

// sameResults : local server -> boolean
// compare entities using a 3-step process
// 1) Weak comparison on locations
// 2) Recursive comparison for objects
// 3) Strong comparison for literals
// if there's a difference, log a diff to the form and return false
// credit to: http://stackoverflow.com/questions/1068834/object-comparison-in-javascript
function sameResults(x, y){
  // given an object, remove empty properties and reconstruct as an alphabetized JSON string
  // then parse and return a canonicalized object
  function canonicalizeObject(obj){
    var fields = [], obj2={};
    for (i in obj) { if (obj.hasOwnProperty(i) && obj[i] !== "") fields.push(i); }
    fields.sort();
    for (var i=0;i<fields.length; i++) { obj2[fields[i]] = obj[fields[i]]; }
    return obj2;
  }

  // if either one is a JSON string, convert it to an object
  try{ var x = JSON.parse(x); }
  catch(e) { /* if it doesn't parse correctly, proceed silently */ }
  try{ var y = JSON.parse(y);}
  catch(e) { /* if it doesn't parse correctly, proceed silently */ }

  // if either one is an object, canonicalize it
  if(typeof(x) === "object") x = canonicalizeObject(x);
  if(typeof(y) === "object") y = canonicalizeObject(y);

  // 1) if both are Locations, we only care about offset and span, so perform a weak comparison
  if ( x.hasOwnProperty('offset') && y.hasOwnProperty('offset') ){
    return ( (x.span == y.span) && (x.offset == y.offset) );
  // 2) if they are both objects, compare each property
  } else if(typeof(x)=="object" && typeof(x)=="object"){
    // does every property in x also exist in y?
    for (var p in x) {
      // log error if a property is not defined
      if ( ! x.hasOwnProperty(p) ){ return false; }
      if ( ! y.hasOwnProperty(p) ){ return false; }
      // if they both have the property, compare it
      if(sameResults(x[p],y[p])) continue;
      else return false;
    }
    // does every property in y also exist in x?
    for (p in y) {
      // log error if a property is not defined
      if ( y.hasOwnProperty(p) && !x.hasOwnProperty(p) ){ return false; }
    }
  // 3)if they are literals, they must be identical
  } else {
      if (x !== y){ return false; }
  }
  return true;
}

function loadTests(){
  var testButton = document.getElementById('runTests'),
      script = document.createElement('script'),
      head = document.getElementsByTagName('head')[0];
  testButton.disabled = true;
  testButton.value = "Loading tests...";
  head.appendChild(script);
  script.type = "text/javascript";
  script.src = "https://spreadsheets.google.com/feeds/list/0AjzMl1BJlJDkdDI2c0VUSHNZMnR6ZVR5S2hXZEdtd1E/1/public/basic?alt=json-in-script&callback=loadSuite";
}

function loadSuite(json){
  for(var i=0; i<json.feed.entry.length; i++){
    rows.push(json.feed.entry[i].content.$t);
    var chunks = rows[i].split(/expr\:|, local\: |, server\: |, firstdifference\: |, reason\: |, desugar\: /);
    var expr = chunks[1].replace(/^\s+/,""), local = chunks[2], server = chunks[3],
               difference = chunks[4], reason = chunks[5], desugar = chunks[6];
    expr = expr.replace(/^\'\'/,"'");
    tests.push({expr: expr, local: local, server: server, reason: reason, desugar: desugar});
  }
  console.log(document.getElementById('runTests'));
  document.getElementById('runTests').disabled=false;
  document.getElementById('runTests').value="Run test-suite";
  document.getElementById('runTests').onclick=function(){runTests(true);};
  document.getElementById('memoryTest').disabled=false;
  console.log('Test Suite data retrieved from Google Drive: '+tests.length+' tests loaded');
}

function runTests(verbose){
  function test(expr, expected, desugarRef){
      console.log('expecting: '+expected);
      // show the result
      var row   = document.createElement('tr'),
          num   = document.createElement('td'),
          test  = document.createElement('td'),
          lex   = document.createElement('td'),
          parse = document.createElement('td'),
          desugar=document.createElement('td');
      num.innerHTML  = (i+1)+')'; // make test nums 1-aligned, instead of 0-aligned
      test.innerHTML = expr;      // show which expr we're testing
      row.appendChild(num);
      row.appendChild(test);
      row.appendChild(lex);
      row.appendChild(parse);
      row.appendChild(desugar);
      table.appendChild(row);
      row.style.background = 'lightgreen';
                        
      // LEX: If we pass when we shouldn't, set to pink and return false.
      // Catch: If we fail better than the server, set to blue and return true.
      // Catch: If we fail equal to the server, set to green and return true.
      // Catch: If we fail when we shoulnd't, set to pink and return false
      lex.innerHTML = 'lex';
      try{
        var sexp = plt.compiler.lex(expr,"<definitions>");
      } catch (e) {
        if(expected === "LOCAL IS BETTER"){ lex.style.background = 'lightblue'; return true; }
        else{
          console.log('comparing\n'+e+'\n to \n'+expected);
          if(sameResults(JSON.parse(e), JSON.parse(expected))){ lex.style.background = 'lightgreen'; return true; }
          else{ row.style.background = 'pink'; return false; }
        }
      }
      lex.style.background = 'lightgreen';
                      
      // PARSE: If we pass when we shouldn't, set to pink and return false.
      // Catch: If we fail better than the server, set to blue and return true.
      // Catch: If we fail equal to the server, set to green and return true.
      // Catch: If we fail when we shoulnd't, set to pink and return false
      parse.innerHTML = 'parse';
      try{
        var AST = plt.compiler.parse(sexp);
      } catch (e) {
        if(expected === "LOCAL IS BETTER"){ parse.style.background = 'lightblue'; return true; }
        else{
          if(sameResults(JSON.parse(e), JSON.parse(expected))){ parse.style.background = 'lightgreen'; return true; }
          else{ row.style.background = 'pink'; return false; }
        }
      }
      parse.style.background = 'lightgreen';
                      
      // DESUGAR AND ANALYZE: If we pass when we shouldn't, set to pink and return false.
      // Catch: If we fail better than the server, set to blue and return true.
      // Catch: If we fail equal to the server, set to green and return true.
      // Catch: If we fail when we shoulnd't, set to pink and return false
      desugar.innerHTML = 'desugar';
      try{
        var desugared = plt.compiler.desugar(AST);
            program   = desugared[0],
            pinfo     = desugared[1],
            pinfo2    = plt.compiler.analyze(program);
      } catch (e) {
        if(expected === "LOCAL IS BETTER"){ desugar.style.background = 'lightblue'; return true; }
        else if(sameResults(JSON.parse(e), JSON.parse(expected))){ desugar.style.background = 'lightgreen'; return true; }
        else{ row.style.background = 'pink'; return false; }
      }
      // if we don't have a desugarRef for this test, call it a questinonable pass move on
      if(desugarRef === undefined) { desugar.style.background = 'rgb(194, 288, 194)'; return true; }
      desugarRef = desugarRef.replace(/\s*/g,"");     // remove whitespace fom desugar reference
      program = program.toString().replace(/\s*/g,"");// remove whitespace from test output
      if(desugarRef !== program.toString()) {
        console.log('DESUGARING ERROR: server desugar is \n'+desugarRef+'\n and local desugar is \n\n'+program+'\n');
        row.style.background = 'pink';
        return false;
      }
      desugar.style.background = 'lightgreen';
/*
      // COMPILE:
      try{  var bytecode = plt.compiler.compile(desugared, pinfo2); }
      catch (e) { throw e; }
*/
      return true;
    }
  
    if(verbose) console.log('running tests');
    var table = document.getElementById('testResults');
    for(var i=0; i<tests.length; i++){
      // run the test
      if(verbose) console.log('///// TEST '+ (i+1) +' ////////////////');
      if(verbose) console.log('testing :'+tests[i].expr);
      var result = test(tests[i].expr, tests[i].server, tests[i].desugar);
      if(result) passed++;
      document.getElementById('status').innerHTML = passed+'/'+(i+1)+' passed';
    }
}
                        
function runMemoryTest(){
  var runs = prompt("How many runs of the test suite would you like to do?"
                    +"This could take a while depending on how many runs are entered,"
                    +"and your computer may become unresponsive."
                    , 20);
  for(i=0; i<runs; i++) runTests(false);
  console.log('Memory test complete');
}
</script>

</head>
<body onload="repl2_setup()">
<textarea cols="80" rows="5" type="text" name="repl-input" id="repl-input" onkeypress="readFromRepl(event)"></textarea>
<hr>
<input type="button" value="Load test-suite" id="runTests" onclick="loadTests();"/>
<input type="button" disabled="true" value="Memory Stress-Test" id="memoryTest" onclick="runMemoryTest()"/>
<br/>
<span id="status"></span>
<table id="testResults" style="font-family:monospace;">
</table>

</body>
</html>